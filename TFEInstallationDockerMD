// TFE installation for Docker with Mounted Disk

pipeline {
  agent any

  parameters {
    string(name: 'PRIVATE_IP', description: 'Private IP of the GCP VM')
    string(name: 'PUBLIC_IP', description: 'Public IP of the GCP VM')
    string(name: 'RELEASE_VERSION', description: 'TFE release version')
    string(name: 'DOMAIN_NAME', description: 'FQDN (e.g. my.domain.com)')
    password(name: 'TFE_LICENSE', description: 'TFE license string')
  }

  environment {
    SSH_USER = "jenkins"
  }

  stages {

    stage('Clone Compose Template') {
      steps {
        git branch: 'main', url: 'https://github.com/kunal-hashicorp/DockerCompose.git'
      }
    }

    stage('Generate compose.yml from template') {
      steps {
        sh '''#!/bin/bash
          mkdir -p fdo-test
          sed -e "s|__TFE_VERSION__|${RELEASE_VERSION}|g" \\
              -e "s|__TFE_LICENSE__|${TFE_LICENSE}|g" \\
              -e "s|__DOMAIN_NAME__|${DOMAIN_NAME}|g" \\
              DockerCompose/compose-template.yml > fdo-test/compose.yml
        '''
      }
    }

    stage('Upload compose.yml to VM') {
      steps {
        sshagent(['gcp-ssh-key']) {
          sh '''#!/bin/bash
            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null jenkins@${PUBLIC_IP} "mkdir -p /home/jenkins/fdo-test"
            scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null fdo-test/compose.yml jenkins@${PUBLIC_IP}:/home/jenkins/fdo-test/
          '''
        }
      }
    }

    stage('Install TFE') {
      steps {
        sshagent(['gcp-ssh-key']) {
          sh '''#!/bin/bash
            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${SSH_USER}@${PUBLIC_IP} bash -s <<'EOF'
              set -euo pipefail

              echo "[INFO] Verifying docker compose is installed..."
              if ! command -v docker &>/dev/null || ! docker compose version &>/dev/null; then
                echo "ERROR: 'docker compose' not found. Please install it before running this pipeline."
                exit 1
              fi

              echo "[INFO] Creating certs directory and preparing compose environment..."
              mkdir -p $HOME/fdo-test/certs
              cd $HOME/fdo-test

              echo "[INFO] Copying TLS certificates..."
              sudo cp -p /etc/letsencrypt/live/${DOMAIN_NAME}/fullchain.pem certs/cert.pem
              sudo cp -p /etc/letsencrypt/live/${DOMAIN_NAME}/privkey.pem certs/key.pem
              cp certs/cert.pem certs/bundle.pem

              echo "[INFO] Logging into Docker registry..."
              set +x
              echo '${TFE_LICENSE}' | sudo docker login --username terraform --password-stdin images.releases.hashicorp.com
              set -x

              echo "[INFO] Starting Docker Compose..."
              sudo docker compose up -d
            EOF
          '''
        }
      }
    }
  }
}
